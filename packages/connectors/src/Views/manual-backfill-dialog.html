<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Manual Backfill - <?= source.constructor.name ?></title>
  <style>
    body { 
      font-family: Arial, sans-serif !important; 
      margin: 10px !important;
      background: white !important;
    }
    
    .warning {
      background: #fff3cd !important;
      border: 1px solid #ffeaa7 !important;
      border-radius: 4px !important;
      padding: 8px !important;
      margin-bottom: 10px !important;
      color: #856404 !important;
      font-size: 13px !important;
    }
    
    .form-group { 
      margin-bottom: 12px !important;
    }
    
    label { 
      display: block !important; 
      font-weight: bold !important; 
      margin-bottom: 6px !important;
      color: #333 !important;
      font-size: 14px !important;
    }
    
    input { 
      width: 100% !important; 
      padding: 8px 12px !important; 
      border-radius: 4px !important; 
      border: 1px solid #ddd !important;
      font-size: 14px !important;
      box-sizing: border-box !important;
    }
    
    input:focus {
      outline: none !important;
      border-color: #4285f4 !important;
      box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.1) !important;
    }
    
    input[type="date"] {
      width: 140px !important;
      max-width: 140px !important;
    }
    
    .field-description { 
      font-size: 12px !important; 
      color: #666 !important; 
      margin-top: 4px !important; 
    }
    
    .buttons { 
      display: flex !important; 
      justify-content: flex-end !important; 
      gap: 12px !important; 
      margin-top: 10px !important;
    }
    
    .btn { 
      padding: 6px 14px !important;
      border: none !important; 
      border-radius: 4px !important; 
      cursor: pointer !important; 
      font-size: 14px !important;
      font-weight: 500 !important;
      transition: background-color 0.2s !important;
    }
    
    .btn:disabled { 
      opacity: 0.6 !important; 
      cursor: not-allowed !important; 
    }
    
    .btn-primary { 
      background: #4285f4 !important; 
      color: #fff !important; 
    }
    
    .btn-primary:hover:not(:disabled) {
      background: #3367d6 !important;
    }
    
    .btn-secondary { 
      background: #f1f3f4 !important; 
      color: #5f6368 !important; 
    }
    
    .btn-secondary:hover {
      background: #e8eaed !important;
    }
  </style>
</head>
<body>
  <div class="warning">
    ⚠️ <strong>Note:</strong> This import will not affect your regular scheduled imports. Your connector will continue from where it left off.
  </div>
  
  <form id="manualBackfillForm">
    <? 
      var config = source.config;
      var manualBackfillFields = [];
      
      // Find fields with manualBackfill attribute
      for (var fieldName in config) {
        var field = config[fieldName];
        if (field.attributes && field.attributes.includes('manualBackfill')) {
          manualBackfillFields.push({
            name: fieldName,
            field: field
          });
        }
      }
      
      for (var i = 0; i < manualBackfillFields.length; i++) {
        var fieldInfo = manualBackfillFields[i];
        var fieldName = fieldInfo.name;
        var field = fieldInfo.field;
    ?>
      <div class="form-group">
        <label for="<?= fieldName ?>"><?= field.label || fieldName ?>:</label>
        <? if (field.requiredType === 'date' || field.type === 'date') { ?>
          <input type="date" id="<?= fieldName ?>" name="<?= fieldName ?>" 
                 style="width: 140px !important; max-width: 140px !important; padding: 8px 12px !important; border-radius: 4px !important; border: 1px solid #ddd !important; font-size: 14px !important; box-sizing: border-box !important;"
                 value="<?= field.default ? field.default.toISOString().split('T')[0] : '' ?>" />
        <? } else if (field.requiredType === 'number' || field.type === 'number') { ?>
          <input type="number" id="<?= fieldName ?>" name="<?= fieldName ?>" 
                 value="<?= field.default || '' ?>" />
        <? } else { ?>
          <input type="text" id="<?= fieldName ?>" name="<?= fieldName ?>" 
                 value="<?= field.default || '' ?>" />
        <? } ?>
        <div class="field-description"><?= field.description || '' ?></div>
      </div>
    <? } ?>
    
    <div class="buttons">
      <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
      <button type="button" class="btn btn-primary" id="runBtn">Run Manual Backfill</button>
    </div>
  </form>
  
  <script>
    const cancelBtn = document.getElementById('cancelBtn');
    const runBtn = document.getElementById('runBtn');
    
    cancelBtn.addEventListener('click', () => google.script.host.close());
    runBtn.addEventListener('click', runManualBackfill);
    
    function runManualBackfill() {
      const startDateInput = document.getElementById('StartDate');
      const endDateInput = document.getElementById('EndDate');
      
      if (!startDateInput || !endDateInput) {
        alert('❌ Error: StartDate and EndDate fields not found');
        return;
      }
      
      if (!startDateInput.value.trim()) {
        alert('❌ Please select Start Date');
        startDateInput.focus();
        return;
      }
      
      if (!endDateInput.value.trim()) {
        alert('❌ Please select End Date');
        endDateInput.focus();
        return;
      }
      
      const startDate = new Date(startDateInput.value);
      const endDate = new Date(endDateInput.value);
      
      if (endDate < startDate) {
        alert('❌ End Date cannot be earlier than Start Date');
        endDateInput.focus();
        return;
      }
      
      const params = [];
      
      const inputs = document.querySelectorAll('#manualBackfillForm input');
      inputs.forEach(input => {
        if (input.value.trim()) {
          let value = input.value.trim();
          
          // For date fields, keep as string (don't convert to Date object)
          // Apps Script will handle the conversion on the server side
          if (input.type === 'number') {
            value = parseFloat(value);
          }
          // For dates, keep as string format "YYYY-MM-DD"
          
          params.push({
            configField: input.name,
            value: value
          });
        }
      });    
      google.script.host.close();
      
      google.script.run.importNewData(RunConfigType.MANUAL_BACKFILL, params);
    }
  </script>
</body>
</html> 